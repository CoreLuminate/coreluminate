---
// Google Analytics with Cookie Consent
// Replace 'G-XXXXXXXXXX' with your actual GA4 Measurement ID

interface GoogleAnalyticsProps {
  measurementId: string;
}

const { measurementId } = Astro.props;
---

<script is:inline define:vars={{ measurementId }}>
  // Ensure the global dataLayer and gtag function exist immediately
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  window.gtag = gtag;

  // 1. Define the default consent state (DENIED)
  // This executes immediately before loading the script. GA will collect basic,
  // cookieless data until the user grants consent.
  gtag("consent", "default", {
    ad_storage: "denied",
    analytics_storage: "denied",
  });

  // 2. Load the Google Analytics script
  (function () {
    const gtagScript = document.createElement("script");
    gtagScript.async = true;
    gtagScript.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
    document.head.appendChild(gtagScript);

    // Initial config command (required, but follows the consent default)
    gtag("js", new Date());
    gtag("config", measurementId, {
      anonymize_ip: true,
      cookie_flags: "SameSite=None;Secure",
    });
  })();

  // 3. Define the function to update consent when the user interacts with the banner
  function updateConsent(accepted) {
    const consentStatus = accepted ? "granted" : "denied";

    // Send the update to GA. GA adjusts its tracking immediately.
    gtag("consent", "update", {
      ad_storage: consentStatus,
      analytics_storage: consentStatus,
    });

    console.log(`Google Analytics consent updated to: ${consentStatus}`);
  }

  // 4. Listen for the 'cookieConsentChange' event from the banner
  window.addEventListener("cookieConsentChange", (event) => {
    // event.detail.accepted should be a boolean (true/false)
    updateConsent(event.detail.accepted);
  });

  // 5. Handle Initial Load (Crucial for users who already accepted)
  document.addEventListener("DOMContentLoaded", () => {
    const consent = localStorage.getItem("cookie-consent");
    const timestamp = localStorage.getItem("cookie-consent-timestamp");
    const today = new Date();
    const expiryDays = 365;

    if (consent === "accepted" && timestamp) {
      const consentDate = new Date(parseInt(timestamp));
      const expiryDate = new Date(consentDate);
      expiryDate.setDate(expiryDate.getDate() + expiryDays);

      if (today < expiryDate) {
        // If valid and accepted, immediately grant consent status to GA.
        updateConsent(true);
      }
    }
  });
</script>
